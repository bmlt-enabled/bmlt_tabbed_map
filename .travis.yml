language: php

php:
  - '7.1'
env:
  global:
    - ZIP_FILENAME=bmlt-tabbed-map-build${TRAVIS_BUILD_NUMBER}-${TRAVIS_COMMIT}.zip
    - S3_BUCKET=archives.bmlt.app
    - S3_KEY=bmlt-tabbed-map
jobs:
  include:

    - stage: lint
      install:
        - composer install
      script:
        - find . -name "*.php" ! -path '*/vendor/*' -print0 | xargs -0 -n1 -P8 php -l
        - vendor/squizlabs/php_codesniffer/bin/phpcs --warning-severity=6 --standard=PSR2 --ignore=vendor --extensions=php --report=summary ./
    - stage: zip file
      env:
        - BUILD_DIR=build
        - DIST_DIR_S3=dist/s3
        - DIST_DIR_GITHUB=dist/github
        - GITHUB_RELEASE_FILENAME=bmlt-tabbed-map.zip
        - PLUGIN="bmlt-tabbed-map"
        - MAINFILE="bmlt_tabbed_map.php"
      script:
        - find ./ -type d | xargs chmod 755
        - find ./ -name '*.php' | xargs chmod 644
        - zip -r $ZIP_FILENAME ./ -x "*.git*" -x "*.editorconfig*" -x "*.travis.yml*" -x "*vendor*" -x "composer.*" && mkdir $BUILD_DIR && mv $ZIP_FILENAME $BUILD_DIR/
      before_deploy:
        - mkdir -p $DIST_DIR_S3 && cp $BUILD_DIR/$ZIP_FILENAME $DIST_DIR_S3/$ZIP_FILENAME
        - mkdir -p $DIST_DIR_GITHUB && cp $BUILD_DIR/$ZIP_FILENAME $DIST_DIR_GITHUB/$GITHUB_RELEASE_FILENAME
        - curl -LO https://raw.githubusercontent.com/bmlt-enabled/bmlt-wordpress-deploy/master/deploy-wordpress.sh
        - chmod +x deploy-wordpress.sh
        - curl -LO https://raw.githubusercontent.com/bmlt-enabled/release-notes-tool/master/release-notes.sh
        - chmod +x release-notes.sh
        - ./release-notes.sh readme.txt "wp"
      deploy:
        - provider: s3
          access_key_id: AKIA3EWZC3OHKYCL5SIY
          secret_access_key:
            secure: KMiRgM9p3iOyZEtwja3piRRwge4jgFy2hhnQqcrWwsu7uN3ewOERF959q5czy2mCkhEZdIQIM1tq/O9thK+x9g6ZO24Zdcr8whJ9YrT4/8kpQAl54UHqq/7sb6wtTOh2HdQeSyIj3wccZTQr5Ef2+8ZKsKLTUflpdy3kUeQMV+l/DYnZYZNFElDygXfPA2eWuVyAu4CUWnjvGdqO60yCM2IswyfGIt4P3NsMm8PekAuSnFpV5tr4xzYEIuCzdml6kNBEz5ukKysVFow+L+YOezzCbe8nY/V26/5DSNKUBEcF6yUMbaNDf5MlBP52IyW4h4NzY7j7V4ZsokAUe5HpoYUH1gbZFrh8SoevtzB2tdUFPmZyMmQr7bnAyEuEZT7CECoaeorbIJ/V6d680DCR9dek2x59nj0G7WaNOqE8cyLofERqfdtGVbVgOQnzzpkY1R61YsZ+2NN9fQ7KYFxsb56lsgU+4TgvG2NtMHnoosX/KBdvaHg6+oA9wEUww+iuQ0p3Kbv/zpPosoUvhdP6gIhgfq8DoSq6VzQsyO5EuROi7wIjzhySH9Sa+G5VKSDrYaFu92z0g9dbeReNgBm+eBpNIjC37rQAO3DYQQ1v3yepWPB0NAkzWKLAueaNzhbPHxBFZ4LrL/r04gPbnb+bSC2G2AGZGVQkVsZ3J7aKhSo=
          bucket: "$S3_BUCKET"
          local_dir: "$DIST_DIR_S3"
          upload-dir: "$S3_KEY"
          skip_cleanup: true
          on:
            all_branches: true
        - provider: releases
          edge: true
          release_notes_file: "changelog.txt"
          token:
            secure: A4coY7WW7IWNWlDCnTXpm+J44KEUk/tV8byvzJIzLpDxRBq+EkJPYhwZfp+6BIpayVGZTd1OK4IefhqTmCPgo57SBJk29YVKqNSoI3W613K+l+ojO3T686aAwqyXak/U3p1Me20qFCIg2j7dXJXh0tQyVT9nfOIde67/wUQl6x+l+b9daXYQ40qyfMswXXvO4qDVlBZBRdHL9ty3dOY2apNv3R1RoLvIUN7gOxAj1rRO+aQiNm8SgmyoIkyIXCi4Sf3twMKL43ZqfyKo8lev13/PfLTJ/9xTjww/LzqWR7beYyBO7yc5ZWoYhlrZkq9Te69dgLz3vp+YqPblGbw3/wUVXq0UBJDNBnhMP7O9JRMt+Vurc3yA8LBBoxpYuC2UW4KFVZTNTCgkh7MksLF7/led3KLZiSuC/zQjljPFQrvBQ2G80+8E5/yuMJnqQrf9mQw/ZhvqbrNsbkiN3YNjBaGdLYK7o0PvTJPoWw19LlErDeGJXwSbZPVTxT1Nj9JwCiZvvXO4zjxPeMxYOI8u3eU3azZY5ncdYXFtxzEknLJSQaygefAnXC/lMjd9GucDftM7uj/nP2BfieoO8zHOfmANpSCqrDpql9hCcQvIcbyxIoqYyqUqaeCY3OX/c8wWlfWQIOjrMRx48oWP6j5lpqGTKY8N64sJ9jK3ee6kwuU=
          file: "$DIST_DIR_GITHUB/$GITHUB_RELEASE_FILENAME"
          name: "$TRAVIS_TAG"
          on:
            tags: true
            condition: $TRAVIS_TAG != *beta*
        - provider: releases
          api_key:
            secure: A4coY7WW7IWNWlDCnTXpm+J44KEUk/tV8byvzJIzLpDxRBq+EkJPYhwZfp+6BIpayVGZTd1OK4IefhqTmCPgo57SBJk29YVKqNSoI3W613K+l+ojO3T686aAwqyXak/U3p1Me20qFCIg2j7dXJXh0tQyVT9nfOIde67/wUQl6x+l+b9daXYQ40qyfMswXXvO4qDVlBZBRdHL9ty3dOY2apNv3R1RoLvIUN7gOxAj1rRO+aQiNm8SgmyoIkyIXCi4Sf3twMKL43ZqfyKo8lev13/PfLTJ/9xTjww/LzqWR7beYyBO7yc5ZWoYhlrZkq9Te69dgLz3vp+YqPblGbw3/wUVXq0UBJDNBnhMP7O9JRMt+Vurc3yA8LBBoxpYuC2UW4KFVZTNTCgkh7MksLF7/led3KLZiSuC/zQjljPFQrvBQ2G80+8E5/yuMJnqQrf9mQw/ZhvqbrNsbkiN3YNjBaGdLYK7o0PvTJPoWw19LlErDeGJXwSbZPVTxT1Nj9JwCiZvvXO4zjxPeMxYOI8u3eU3azZY5ncdYXFtxzEknLJSQaygefAnXC/lMjd9GucDftM7uj/nP2BfieoO8zHOfmANpSCqrDpql9hCcQvIcbyxIoqYyqUqaeCY3OX/c8wWlfWQIOjrMRx48oWP6j5lpqGTKY8N64sJ9jK3ee6kwuU=
          file: "$DIST_DIR_GITHUB/$GITHUB_RELEASE_FILENAME"
          skip_cleanup: true
          name: "$TRAVIS_TAG"
          prerelease: true
          on:
            tags: true
            condition: $TRAVIS_TAG =~ "beta"
        - provider: script
          script: ./deploy-wordpress.sh
          skip_cleanup: true
          on:
            tags: true
notifications:
  slack:
    rooms:
      - secure: bmoIugz9sorNakDw7LnfC3iB7a4CnhuZeZBAVxefSoqipbZAGLoA86pSaDwSK3kNsCRAUXyHJ0pBxxJuCO5jrQKhl9TNBFQQ60KPvn3LQj9OXXTSHp4qoqBytipQGyjeqySu4fJt8Lc0u8FQ0qinxn21qF7K7c54aygVKQd+nxf/+9rVzSOJIY+c6UEBb9FwKfHl9cOJy8nTHYPNl0ZbQaYVS1gvyOV2jzrlurOXb0t2xYs2W9EOAjUd2E4ZVaD8EEyRZ9zcvy8ne41qZGBLMJjHZo6TdN4x0AdEYiITst5fKj+YILNCaVQMyURu5h65RPVXyjZ/eIOUixSt1EOpMTxWcRiDn3H7B2F7eEUIXyo/c5x1AEWEQFLGK+/PEqWx/zaBG0rJJdzVbLaqet2kg5piy+f84EBCZiXm7CZIYPMSjLJo9AJDcY9iSRgvpRnkSagHZAgMILNut53aNPd8i3FoOeycPwux/KDQpSz0uIpn4xu26VY0bzxJ8N27VugUhmNhLCN05Hgw8GoDjEoh4EgPPsdNVzXT4mzpjx2GfhRZOm/78LUSDB/w3oIAEPzRFfhberBAo0l2w9T5+Ynbw9yyquYgNUOW/nMhbwqOPbWqndHa8Xume0DXp2COHEqoSZx4gDIIRRKjKdsrFjjasWB5K7IQXQfBoiGAL7EscNA=
    on_success: change
  email: false
